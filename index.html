<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HGeSM - Guias de Encaminhamento e Conv√™nios</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  /* Vari√°veis de Cores (Ajustadas para o Layout.jpg) */
  :root {
    --bg-color: #f7f9fc;
    --shadow-light: #ffffff;
    --shadow-dark: #d1d5db;
    --blue-main: #0d6efd;
    --text-color: #333;
    --red-main: #dc3545; 
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #eef2f5; 
    padding: 20px;
  }

  /* Estilo Centralizado para o Container Principal */
  .main-wrapper {
    max-width: 1000px;
    margin: 0 auto; 
    background: var(--bg-color);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  /* Cabe√ßalho do Site (Topo) - Ajuste de Alinhamento e Cores */
  .site-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* Permite que o elemento central defina a altura */
    text-align: center;
    margin-bottom: 25px;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 15px;
  }

  /* Estilo Base dos Links/Bot√µes no Cabe√ßalho */
  .site-header a, .site-header .header-button { 
    font-weight: 600;
    color: var(--text-color); 
    text-decoration: none;
    cursor: pointer; 
    /* Regras de Alinhamento: Faz o link ocupar a altura total e centraliza o texto */
    padding: 0 15px; /* Padding horizontal mantido */
    height: 100%; 
    display: flex;
    flex-direction: column;
    justify-content: center; /* Centraliza o texto verticalmente */
    transition: color 0.2s, background-color 0.2s;
  }

  /* Estilo para Bot√£o Selecionado */
  .site-header a.active, .site-header .header-button.active {
    color: var(--blue-main); /* Cor Ativa: Azul */
  }

  /* T√≠tulo Central (Conv√™nios HGeSM) */
  .site-title {
    flex-grow: 1;
    text-align: center;
    padding: 10px 0; 

    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .site-title img { width: 60px; height: auto; margin-bottom: 5px; }
  .site-title p { margin: 0; font-size: 1.2em; color: #6c757d; }

  /* Estilo para o Texto de Conv√™nios HGeSM (maior) */
  .site-title h2 { 
      font-size: 1.8em; 
      font-weight: 700; 
      color: inherit; 
      margin: 5px 0 0; 
      transition: color 0.2s;
  }

  /* Ajuste de Fonte para os bot√µes laterais (Solicitar/Excluir) */
  .site-header .side-button {
      font-size: 1.5em;
      margin: 125px 60px 0; 
  }

  /* Lista de Conv√™nios */
  .search-box { margin: 20px 0; }
  .grupo h4 { background: var(--blue-main); color: white; padding: 10px; border-radius: 8px; font-size: 1.2em; margin-bottom: 15px; }
  .card { margin-bottom: 8px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05); }
  .card p { margin: 2px 0; font-size: 0.9em; }
  .card a { color: var(--red-main); text-decoration: none; font-weight: 600; }

  /* Estilos para Formul√°rios (Herdados do App Web anterior, simplificados) */
  .form-group label { font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 4px; }
  .form-control-app {
    padding: 10px; border-radius: 8px; border: 1px solid #ccc;
    box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1);
    font-size: 0.9em; width: 100%; box-sizing: border-box;
    margin-bottom: 15px;
  }
  .form-control-app:focus { border-color: var(--blue-main); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25); outline: 0; }
  
  /* Layout de Formul√°rio em Grid */
  #initialDataForm { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 20px 0; border-top: 1px dashed #ccc; margin-top: 20px; }
  #precCpGroup, #inputEmail { grid-column: 1 / -1; }
  .prec-input-container { display: flex; gap: 8px; }
  .prec-main-input { flex-grow: 1; }
  .prec-final-select select { width: 80px; padding: 10px 4px; border-radius: 8px; border: 1px solid #ccc; }
  .prec-not-have { display: flex; align-items: center; gap: 8px; margin-top: 8px; }

  .submit-btn { width: 100%; padding: 10px; border-radius: 8px; font-weight: bold; margin-top: 10px; }
  .back-btn { margin-top: 10px; padding: 5px; background: none; border: none; color: var(--blue-main); font-weight: 600; cursor: pointer; }
  
  /* Bot√£o de WhatsApp Flutuante */
  .whatsapp-fusex {
    position: fixed; bottom: 20px; right: 20px; background-color: #25D366; color: white; border-radius: 50%; width: 60px; height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-decoration: none; z-index: 1000; font-size: 0.8em; padding: 5px;
  }
  .whatsapp-fusex img { width: 30px; height: 30px; margin-bottom: 2px; }

  @media (max-width: 768px) {
    #initialDataForm { grid-template-columns: 1fr; }
    .site-header { flex-direction: column; }
    .site-header a { margin: 5px 0; }
    .site-title { margin: 10px 0; }
  }
</style>
</head>
<body>

<div class="main-wrapper">
    <div class="site-header">
        <a href="#" class="side-button" id="solicitarBtn" onclick="initiateAction('solicitar'); return false;">Solicitar GUIA</a>

        <div class="site-title header-button" id="conveniosBtn" onclick="showScreen('conveniosArea'); updateHeaderColor('convenios');">
            <img src="HGeSM.png" alt="Logo HGeSM">
            <p>Seu hospital, sua refer√™ncia.</p>
            <h2>üìå Conv√™nios HGeSM</h2>
        </div>

        <a href="#" class="side-button" id="excluirBtn" onclick="initiateAction('excluir'); return false;">Excluir GUIA</a>
    </div>

    <div id="mainContentArea">
        <div id="conveniosArea">
            <input id="search" class="form-control search-box" type="text" placeholder="üîç Pesquise por exame, cl√≠nica, endere√ßo...">
            <div id="lista"></div>
        </div>

        <div id="identificationArea" style="display: none;">
            <h3 class="text-center mb-4" id="identificationTitle"></h3>
            <p class="text-center text-secondary">
                Preencha seus dados para continuar a <strong id="actionText"></strong>.
            </p>
            
            <div id="initialDataForm">
                <div class="form-group">
                    <label for="inputName">NOME COMPLETO:</label>
                    <input type="text" id="inputName" class="form-control-app" placeholder="Seu nome completo" required>
                </div>
                <div class="form-group">
                    <label for="inputCpf">CPF:</label>
                    <input type="text" id="inputCpf" class="form-control-app" placeholder="000.000.000-00" required>
                </div>

                <div class="form-group" id="precCpGroup">
                    <label>PREC CP: (Se n√£o tiver, marque "N√£o tenho")</label>
                    <div class="prec-input-container">
                        <div class="prec-main-input">
                            <input type="text" id="inputPrecCpMain" class="form-control-app" placeholder="N√∫mero do PREC CP">
                        </div>
                        <div class="prec-final-select">
                            <label>FINAL</label>
                            <select id="selectPrecCpFinal" class="form-control-app"></select>
                        </div>
                    </div>
                    <div class="prec-not-have">
                        <input type="checkbox" id="checkPrecCpNotHave">
                        <label for="checkPrecCpNotHave">N√ÉO TENHO</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputEmail">E-mail: (Para onde enviaremos o PDF)</label>
                    <input type="email" id="inputEmail" class="form-control-app" placeholder="seu@email.com" required>
                </div>
            </div>
            
            <button class="btn btn-primary submit-btn" id="startActionBtn">AVAN√áAR</button>
            <button class="back-btn" onclick="showScreen('conveniosArea')">‚Üê Voltar √† Lista de Conv√™nios</button>
        </div>

        <div id="requestGuideArea" style="display: none;">
            <h3 class="text-primary">Solicitar Guia de Encaminhamento</h3>
            <div id="feedbackMessageRequest" class="alert mt-3" style="display: none;"></div>
            
            <div class="form-group">
                <label for="clinicNameDisplay">Cl√≠nica Selecionada:</label>
                <input type="text" id="clinicNameDisplay" class="form-control-app" placeholder="Selecione na lista ou preencha" readonly>
                <small class="text-muted">Se voc√™ clicou em uma cl√≠nica, o nome aparecer√° aqui.</small>
            </div>
            
            <div class="form-group">
                <label for="examInput">EXAME SOLICITADO (Obrigat√≥rio):</label>
                <input type="text" id="examInput" class="form-control-app" placeholder="Ex: Resson√¢ncia Magn√©tica de Joelho" required>
            </div>
            
            <div class="form-group">
                <label for="medicalOrderFile">ANEXAR PEDIDO M√âDICO (Obrigat√≥rio):</label>
                <input type="file" id="medicalOrderFile" class="form-control-app" accept="image/*,.pdf" required>
                <small class="text-muted">Apenas imagens (JPG, PNG) ou PDF.</small>
            </div>

            <button class="btn btn-primary submit-btn" id="submitRequestBtn">SOLICITAR GUIA</button>
            <button class="back-btn" onclick="showScreen('conveniosArea')">‚Üê Voltar √† Lista de Conv√™nios</button>
        </div>

        <div id="deleteGuideArea" style="display: none;">
            <h3 class="text-danger">Exclus√£o de Guia</h3>
            <div id="feedbackMessageDelete" class="alert mt-3" style="display: none;"></div>
            
            <div class="form-group">
                <label for="guideNumberInput">N√öMERO DA GUIA PARA EXCLUS√ÉO:</label>
                <input type="text" id="guideNumberInput" class="form-control-app" placeholder="Ex: 2024.12345" required>
            </div>
            
            <button class="btn btn-danger submit-btn" id="submitDeleteBtn">SOLICITAR EXCLUS√ÉO</button>
            <button class="back-btn" onclick="showScreen('conveniosArea')">‚Üê Voltar √† Lista de Conv√™nios</button>
        </div>
    </div>
</div>

<a href="https://wa.me/5532202408" target="_blank" class="whatsapp-fusex">
    <img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png" alt="WhatsApp">
    <span><strong>FuSEx</strong></span>
</a>

<script>
// =================================================================================
// !!! 1. ATEN√á√ÉO: SUBSTITUA PELA SUA URL DE IMPLANTA√á√ÉO DO GOOGLE APPS SCRIPT (FINAL /exec) !!!
// =================================================================================
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQGvBA9BMJSKFnl4_xeKPKd7lf90uw-MXxqjgkI2fvDKYpOZQ21EJtvKk_c6npJexnWA/exec"; 
// =================================================================================
// !!! 2. ATEN√á√ÉO: SUBSTITUA PELA SUA URL DO CSV P√öBLICO DE CONV√äNIOS !!!
// =================================================================================
const CONVENIOS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiLAhk5UOYqyWcABYui1vxCAlTlDMbkJ5c-o3wl03A73Vy9HcKV9w7p8EsOtPMU1RKBA1tF_arWD88/pub?output=csv';
// =================================================================================

let currentAction = null; 
let patientData = {}; 
let allClinics = []; 

// Vari√°veis dos bot√µes do cabe√ßalho
const solicitarBtn = document.getElementById('solicitarBtn');
const excluirBtn = document.getElementById('excluirBtn');
const conveniosBtn = document.getElementById('conveniosBtn');
const conveniosTitle = conveniosBtn.querySelector('h2');


// Vari√°veis de Elementos
const conveniosArea = document.getElementById('conveniosArea');
const identificationArea = document.getElementById('identificationArea');
const requestGuideArea = document.getElementById('requestGuideArea');
const deleteGuideArea = document.getElementById('deleteGuideArea');
const identificationTitle = document.getElementById('identificationTitle');
const actionText = document.getElementById('actionText');
const startActionBtn = document.getElementById('startActionBtn');
const clinicNameDisplay = document.getElementById('clinicNameDisplay');
const submitRequestBtn = document.getElementById('submitRequestBtn');
const submitDeleteBtn = document.getElementById('submitDeleteBtn');
const medicalOrderFile = document.getElementById('medicalOrderFile'); // NOVO: Campo de anexo

// Vari√°veis de Input
const inputName = document.getElementById('inputName');
const inputCpf = document.getElementById('inputCpf');
const inputEmail = document.getElementById('inputEmail');
const inputPrecCpMain = document.getElementById('inputPrecCpMain');
const selectPrecCpFinal = document.getElementById('selectPrecCpFinal');
const checkPrecCpNotHave = document.getElementById('checkPrecCpNotHave');
const examInput = document.getElementById('examInput');
const guideNumberInput = document.getElementById('guideNumberInput');

// ----------------------------------------------------
// Fun√ß√µes Auxiliares de UI/Navega√ß√£o
// ----------------------------------------------------

function generatePrecCpOptions() {
    for (let i = 0; i <= 50; i++) {
        const value = i.toString().padStart(2, '0');
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        selectPrecCpFinal.appendChild(option);
    }
}
checkPrecCpNotHave.addEventListener('change', () => {
    const disabled = checkPrecCpNotHave.checked;
    inputPrecCpMain.disabled = disabled;
    selectPrecCpFinal.disabled = disabled;
    
    if (disabled) {
        inputPrecCpMain.value = '';
        selectPrecCpFinal.value = '00';
    }
});


// Fun√ß√£o para mudar a cor do bot√£o ativo no cabe√ßalho
function updateHeaderColor(activeElementId) {
    solicitarBtn.classList.remove('active');
    excluirBtn.classList.remove('active');
    conveniosTitle.style.color = 'inherit'; 

    if (activeElementId === 'solicitar') {
        solicitarBtn.classList.add('active');
    } else if (activeElementId === 'excluir') {
        excluirBtn.classList.add('active');
    } else if (activeElementId === 'convenios') {
        conveniosTitle.style.color = 'var(--blue-main)';
    }
}


function showScreen(screenId) {
    conveniosArea.style.display = 'none';
    identificationArea.style.display = 'none';
    requestGuideArea.style.display = 'none';
    deleteGuideArea.style.display = 'none';

    const targetElement = document.getElementById(screenId);
    if (targetElement) {
        targetElement.style.display = 'block';
    }
    
    // Limpa o feedback ao mudar de tela
    document.getElementById('feedbackMessageRequest').style.display = 'none';
    document.getElementById('feedbackMessageDelete').style.display = 'none';

    if (screenId === 'conveniosArea') {
        updateHeaderColor('convenios');
    } else if (screenId === 'identificationArea') {
        updateHeaderColor(currentAction); 
    } else if (screenId === 'requestGuideArea') {
        updateHeaderColor('solicitar'); 
    } else if (screenId === 'deleteGuideArea') {
        updateHeaderColor('excluir'); 
    }
}

function initiateAction(action) {
    currentAction = action;
    const title = action === 'solicitar' ? 'Solicita√ß√£o de Guia' : 'Exclus√£o de Guia';
    const text = action === 'solicitar' ? 'Solicita√ß√£o de Guia' : 'Exclus√£o de Guia';
    
    identificationTitle.textContent = title;
    actionText.textContent = text;
    
    updateHeaderColor(action); 
    
    showScreen('identificationArea');
}

function displayFeedback(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = `alert alert-${type === 'success' ? 'success' : 'danger'} mt-3`;
    element.style.display = 'block';
    setTimeout(() => { element.style.display = 'none'; }, 5000);
}


// ----------------------------------------------------
// L√≥gica de Conv√™nios
// ----------------------------------------------------

function fetchConvenios() {
    fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(CONVENIOS_CSV_URL)}`)
        .then(response => response.text())
        .then(csv => {
            const linhas = csv.trim().split(/\r?\n/).map(l => l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
            linhas.shift();
            allClinics = linhas.map(l => ({
                especialidade: l[0]?.replace(/"/g, ''),
                clinica: l[1]?.replace(/"/g, ''),
                endereco: l[2]?.replace(/"/g, ''),
                contato: l[3]?.replace(/"/g, '')
            }));
            renderConvenios(allClinics);
        })
        .catch(err => {
            document.getElementById('lista').innerHTML = '<p class="text-danger text-center mt-4">Erro ao carregar os dados dos conv√™nios (CORS). Tente novamente mais tarde.</p>';
        });
}


function renderConvenios(data) {
    const container = document.getElementById('lista');
    container.innerHTML = '';

    const grupos = {};
    data.forEach(item => {
        if (!item.especialidade) return;
        const esp = item.especialidade;
        if (!grupos[esp]) grupos[esp] = [];
        grupos[esp].push(item);
    });

    Object.keys(grupos).sort().forEach(esp => {
        const divGrupo = document.createElement('div');
        divGrupo.className = 'grupo';
        divGrupo.innerHTML = `<h4>ü©∫ ${esp}</h4>`;

        grupos[esp].forEach(item => {
            const telefoneHref = item.contato ? `https://wa.me/55${item.contato.replace(/\D/g,'')}` : '#';
            const telefoneText = item.contato ? `üìû ${item.contato}` : 'Telefone N√£o Informado';
            divGrupo.innerHTML += `
                <div class="card p-3 shadow-sm" onclick="selectClinicForRequest('${item.clinica}')" style="cursor:pointer;">
                    <p><strong>Cl√≠nica:</strong> ${item.clinica || 'Cl√≠nica sem Nome'}</p>
                    <p><strong>Endere√ßo:</strong> ${item.endereco || 'N√£o Informado'}</p>
                    <p><a href='${telefoneHref}' target='_blank'>${telefoneText}</a></p>
                </div>`;
        });

        container.appendChild(divGrupo);
    });

    document.getElementById('search').addEventListener('keyup', function() {
        const q = this.value.toLowerCase();
        container.querySelectorAll('.grupo').forEach(grupo => {
            grupo.style.display = grupo.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        });
    });
}

function selectClinicForRequest(clinicName) {
    clinicNameDisplay.value = clinicName;
    initiateAction('solicitar');
}

// ----------------------------------------------------
// L√≥gica de Valida√ß√£o e Transi√ß√£o do Formul√°rio de Identifica√ß√£o
// ----------------------------------------------------

startActionBtn.addEventListener('click', () => {
    // 1. Valida√ß√£o de campos obrigat√≥rios
    const name = inputName.value.trim();
    const cpf = inputCpf.value.trim();
    const email = inputEmail.value.trim();
    
    if (name === '' || cpf === '' || email === '') {
        alert("Por favor, preencha o Nome, CPF e E-mail para avan√ßar.");
        return; 
    }

    // 2. Coleta e formata√ß√£o dos dados
    const precCpMain = inputPrecCpMain.value.trim();
    
    let finalPrecCpValue;
    if (checkPrecCpNotHave.checked) {
        finalPrecCpValue = 'N√£o tenho';
    } else if (precCpMain === '') {
        finalPrecCpValue = 'N√£o informado';
    } else {
        finalPrecCpValue = `${precCpMain}-${selectPrecCpFinal.value}`;
    }
    
    patientData = {
        name: name,
        cpf: cpf,
        prec_cp: finalPrecCpValue,
        email: email
    };

    // 3. Transiciona para a tela de a√ß√£o espec√≠fica
    if (currentAction === 'solicitar') {
        showScreen('requestGuideArea');
    } else if (currentAction === 'excluir') {
        showScreen('deleteGuideArea');
    }
});


// ----------------------------------------------------
// L√≥gica de Submiss√£o para Google Apps Script (COM ANEXO)
// ----------------------------------------------------

// 1. Submiss√£o da Solicita√ß√£o de Guia
submitRequestBtn.addEventListener('click', async () => {
    const examName = examInput.value.trim();
    const clinicName = clinicNameDisplay.value.trim();
    const file = medicalOrderFile.files[0]; // Pega o primeiro arquivo selecionado

    if (clinicName === '' || examName === '') {
        alert("Por favor, preencha o nome da cl√≠nica e o exame solicitado.");
        return;
    }
    if (!file) { // Verifica se um arquivo foi selecionado
        alert("Por favor, anexe o pedido m√©dico.");
        return;
    }

    // Usamos FormData para enviar o arquivo junto com os outros dados
    const formData = new FormData();
    formData.append('action', 'solicitar_guia'); // A√ß√£o para o Apps Script
    formData.append('name', patientData.name);
    formData.append('cpf', patientData.cpf);
    formData.append('prec_cp', patientData.prec_cp);
    formData.append('email', patientData.email);
    formData.append('clinicName', clinicName);
    formData.append('examName', examName);
    formData.append('medicalOrderFile', file); // Anexa o arquivo!

    submitRequestBtn.disabled = true;
    submitRequestBtn.textContent = 'ENVIANDO SOLICITA√á√ÉO E ANEXO...';

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            // N√ÉO inclua Content-Type para FormData
            body: formData // Envia o FormData
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayFeedback('feedbackMessageRequest', '‚úÖ ' + result.message + ' Voc√™ ser√° notificado por e-mail.', 'success');
            examInput.value = ''; 
            medicalOrderFile.value = ''; // Limpa o input do arquivo
        } else {
            displayFeedback('feedbackMessageRequest', '‚ùå Erro: ' + result.message, 'error');
        }
    } catch (error) {
        displayFeedback('feedbackMessageRequest', '‚ùå Erro de conex√£o com o servidor. Verifique o APPS_SCRIPT_URL ou sua rede.', 'error');
        console.error("Erro no envio da solicita√ß√£o:", error);
    } finally {
        submitRequestBtn.textContent = 'SOLICITAR GUIA';
        submitRequestBtn.disabled = false;
    }
});

// 2. Submiss√£o da Exclus√£o de Guia (N√£o requer altera√ß√£o)
submitDeleteBtn.addEventListener('click', async () => {
    const guideNumber = guideNumberInput.value.trim();
    
    if (guideNumber === '') {
        alert("Por favor, preencha o n√∫mero da guia para exclus√£o.");
        return;
    }

    const payload = {
        action: 'excluir_guia',
        ...patientData, 
        guideNumber: guideNumber
    };

    submitDeleteBtn.disabled = true;
    submitDeleteBtn.textContent = 'ENVIANDO EXCLUS√ÉO...';

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            contentType: 'application/json',
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayFeedback('feedbackMessageDelete', '‚úÖ ' + result.message, 'success');
            guideNumberInput.value = ''; 
        } else {
            displayFeedback('feedbackMessageDelete', '‚ùå Erro: ' + result.message, 'error');
        }
    } catch (error) {
        displayFeedback('feedbackMessageDelete', '‚ùå Erro de conex√£o com o servidor. Verifique o APPS_SCRIPT_URL ou sua rede.', 'error');
    } finally {
        submitDeleteBtn.textContent = 'SOLICITAR EXCLUS√ÉO';
        submitDeleteBtn.disabled = false;
    }
});


// ----------------------------------------------------
// Inicializa√ß√£o
// ----------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    generatePrecCpOptions();
    fetchConvenios();
    showScreen('conveniosArea'); 
    updateHeaderColor('convenios'); 
});
</script>

</body>
</html>
